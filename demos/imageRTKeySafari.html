<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/jspsych.js"></script>
    <script type="text/javascript" src="../js/pwt.js"></script>
<title>Page title whatever you want</title>
<style type="text/css">
/* Please add your css here or in an external file */
body {
    margin: 0;
    padding: 0;
}
#mainCanvas {
    position:absolute;
    top: 0px;
    left: 0px;
    z-index: 1;
}
</style>

<script type="text/javascript">

onload = function() {
    document.addEventListener("keyup", keyUpFunc);
    document.addEventListener("keydown", keyDownFunc);
    document.addEventListener("mouseup", mouseUpFunc);
    document.addEventListener("mousedown", mouseDownFunc);
    document.addEventListener("mousemove", mouseMoveFunc);
    
    runExp();
}

// Please note that when you change the size of the window the program is initialized.
resizeTimer = false;
resizeFlag = true;
onresize = function (){
    if (resizeFlag) {
        if (resizeTimer !== false) {
            clearTimeout(resizeTimer);
        }
        resizeTimer = setTimeout(function() {
            location.reload();
        }, 200);
    }
}

async function runExp() { // "async" is needed.
    myCanvas = document.getElementById('mainCanvas');
    if (!myCanvas || !myCanvas.getContext) {
        alert("Your web browser does not meet the requirements for this program.");
        return false;
    }

    participant = prompt('Please enter your name.');

    // Canvas fits the entire window
    myCanvas.width = window.innerWidth;
    myCanvas.height = window.innerHeight;

    centerX = myCanvas.width / 2;
    centerY = myCanvas.height / 2;

    zoom = 0.7; // More than 1 expand an image, less than 1 downsize an image. 
    
    ctx = myCanvas.getContext('2d');

    bgColor = "rgb(128, 128, 128)"; // Back ground color
    stimColor = "rgb(255, 255, 255)"; // Stimulus color

    images = [
        '../images/1.jpg',
        '../images/2.jpg',
        '../images/3.jpg',
    ];

    randImages = randomization(images, 2); // the second argument means the number of repetitions

    document.body.style.cursor = "none"; // delete the cursor

    for (i = 0; i < randImages.length; i++) {
        testImage = await loadImage(randImages[i]); // It takes time

        // Instraction
        clearWindow(ctx, bgColor);
        ctx.font = "22px 'Arial'";
        drawText(ctx, 'Please press a space key.', centerX, centerY, stimColor);
        await pressKey([" "]); // A space between double quotation is needed.

        // fixation cross
        clearWindow(ctx, bgColor); // delete the instraction        
        drawLine(ctx, centerX, centerY - 10, centerX, centerY + 10, 4, "rgb(0, 0, 0)"); // vertical line
        drawLine(ctx, centerX - 10, centerY, centerX + 10, centerY, 4, "rgb(0, 0, 0)"); // horizontal line
        await milliseconds(1000); // duration of the fixation cross

        // present a image
        clearWindow(ctx, bgColor);
        drawText(ctx, 'Please press a space key.', centerX, 100, stimColor);
        startTime = showImage(ctx, testImage, centerX, centerY, zoom); // "showImage" function returns the time when the image appears in a display.

        pressTime = await pressKey([" "]); // waiting for a key response (space key)
        rt = keyDownEvent.timeStamp - startTime; // reaction time
        rt2 = pressTime - startTime;

        console.log(rt); // invalid
        console.log(rt2); // valid but not precise

        // storing the data
        trial_data = {};
		trial_data['participant'] = participant;
		trial_data['trial'] = i + 1;
        trial_data['imgFile'] = randImages[i];
        trial_data['RT(ms)'] = rt; // invalid
        trial_data['RT2(ms)'] = rt2; // valid but not precise

        writeData(trial_data);
    }

    clearWindow(ctx, bgColor);

    saveCSV(participant);

    drawText(ctx, 'The experiment finished.', centerX, centerY, stimColor);
    document.body.style.cursor = "auto"; // restore the cursor
    resizeFlag = false;

}

</script>
</head>
<body>
    <canvas id="mainCanvas"></canvas> 
    <canvas id="circleID"></canvas> 
</body>
</html>
